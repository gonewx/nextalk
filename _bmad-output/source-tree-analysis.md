# Nextalk æºç æ ‘åˆ†æ

## ç›®å½•ç»“æ„æ¦‚è§ˆ

```
nextalk_fcitx5_v2/
â”œâ”€â”€ addons/                   # [Part 2] åç«¯ - Fcitx5 C++ æ’ä»¶
â”‚   â””â”€â”€ fcitx5/
â”‚       â”œâ”€â”€ CMakeLists.txt    # CMake æ„å»ºé…ç½®
â”‚       â”œâ”€â”€ build/            # æ„å»ºè¾“å‡º (gitignore)
â”‚       â””â”€â”€ src/
â”‚           â”œâ”€â”€ nextalk.cpp   # ğŸ“Œ æ’ä»¶æ ¸å¿ƒå®ç°
â”‚           â”œâ”€â”€ nextalk.h     # å¤´æ–‡ä»¶
â”‚           â””â”€â”€ nextalk.conf.in  # é…ç½®æ¨¡æ¿
â”‚
â”œâ”€â”€ voice_capsule/            # [Part 1] å‰ç«¯ - Flutter æ¡Œé¢å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ pubspec.yaml          # Dart ä¾èµ–é…ç½®
â”‚   â”œâ”€â”€ linux/                # Linux å¹³å°é…ç½®
â”‚   â”‚   â”œâ”€â”€ CMakeLists.txt    # ğŸ“Œ åº“é“¾æ¥é…ç½® (RPATH)
â”‚   â”‚   â”œâ”€â”€ flutter/          # Flutter å¼•æ“é›†æˆ
â”‚   â”‚   â””â”€â”€ runner/           # C++ Runner (çª—å£ç®¡ç†)
â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â””â”€â”€ icons/            # æ‰˜ç›˜å›¾æ ‡èµ„æº
â”‚   â”œâ”€â”€ lib/                  # ğŸ“Œ Dart æºç 
â”‚   â”‚   â”œâ”€â”€ main.dart         # â˜… åº”ç”¨å…¥å£
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”‚   â””â”€â”€ nextalk_app.dart  # MaterialApp é…ç½®
â”‚   â”‚   â”œâ”€â”€ constants/        # å¸¸é‡å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ animation_constants.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ capsule_colors.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ hotkey_constants.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ settings_constants.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ tray_constants.dart
â”‚   â”‚   â”‚   â””â”€â”€ window_constants.dart
â”‚   â”‚   â”œâ”€â”€ ffi/              # ğŸ“Œ FFI ç»‘å®šå±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ sherpa_ffi.dart        # Sherpa-onnx C-API ç»‘å®š
â”‚   â”‚   â”‚   â”œâ”€â”€ sherpa_onnx_bindings.dart
â”‚   â”‚   â”‚   â””â”€â”€ portaudio_ffi.dart     # PortAudio C-API ç»‘å®š
â”‚   â”‚   â”œâ”€â”€ services/         # ğŸ“Œ ä¸šåŠ¡é€»è¾‘æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ sherpa_service.dart    # â˜… AI æ¨ç†æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ audio_capture.dart     # â˜… éŸ³é¢‘é‡‡é›†
â”‚   â”‚   â”‚   â”œâ”€â”€ audio_inference_pipeline.dart  # â˜… éŸ³é¢‘â†’æ¨ç†æµæ°´çº¿
â”‚   â”‚   â”‚   â”œâ”€â”€ fcitx_client.dart      # â˜… Fcitx5 é€šä¿¡å®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”œâ”€â”€ command_server.dart    # å‘½ä»¤æœåŠ¡å™¨ (Wayland)
â”‚   â”‚   â”‚   â”œâ”€â”€ model_manager.dart     # æ¨¡å‹ä¸‹è½½ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ settings_service.dart  # é…ç½®ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ tray_service.dart      # ç³»ç»Ÿæ‰˜ç›˜
â”‚   â”‚   â”‚   â”œâ”€â”€ window_service.dart    # çª—å£ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ hotkey_service.dart    # å¿«æ·é”®æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ hotkey_controller.dart # å¿«æ·é”®æ§åˆ¶å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ language_service.dart  # å›½é™…åŒ–æœåŠ¡
â”‚   â”‚   â”‚   â””â”€â”€ animation_ticker_service.dart
â”‚   â”‚   â”œâ”€â”€ state/            # çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ capsule_state.dart
â”‚   â”‚   â”‚   â””â”€â”€ init_state.dart
â”‚   â”‚   â”œâ”€â”€ ui/               # ğŸ“Œ UI ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ capsule_widget.dart    # â˜… ä¸»èƒ¶å›Šç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ breathing_dot.dart     # å‘¼å¸ç¯åŠ¨ç”»
â”‚   â”‚   â”‚   â”œâ”€â”€ ripple_effect.dart     # æ³¢çº¹æ•ˆæœ
â”‚   â”‚   â”‚   â”œâ”€â”€ pulse_indicator.dart   # è„‰å†²æŒ‡ç¤ºå™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ capsule_text_preview.dart  # æ–‡æœ¬é¢„è§ˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ cursor_blink.dart      # å…‰æ ‡é—ªçƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ state_indicator.dart   # çŠ¶æ€æŒ‡ç¤º
â”‚   â”‚   â”‚   â”œâ”€â”€ error_action_widget.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ fatal_error_dialog.dart
â”‚   â”‚   â”‚   â””â”€â”€ init_wizard/           # åˆå§‹åŒ–å‘å¯¼
â”‚   â”‚   â”œâ”€â”€ l10n/             # å›½é™…åŒ–èµ„æº
â”‚   â”‚   â”‚   â”œâ”€â”€ app_en.arb
â”‚   â”‚   â”‚   â”œâ”€â”€ app_zh.arb
â”‚   â”‚   â”‚   â””â”€â”€ app_localizations*.dart
â”‚   â”‚   â””â”€â”€ utils/            # å·¥å…·ç±»
â”‚   â”‚       â”œâ”€â”€ diagnostic_logger.dart
â”‚   â”‚       â””â”€â”€ clipboard_helper.dart
â”‚   â””â”€â”€ test/                 # æµ‹è¯•æ–‡ä»¶
â”‚
â”œâ”€â”€ docs/                     # è®¾è®¡æ–‡æ¡£
â”‚   â”œâ”€â”€ prd.md                # äº§å“éœ€æ±‚æ–‡æ¡£
â”‚   â”œâ”€â”€ architecture.md       # æ¶æ„æ–‡æ¡£
â”‚   â””â”€â”€ front-end-spec.md     # UI/UX è§„èŒƒ
â”‚
â”œâ”€â”€ scripts/                  # DevOps è„šæœ¬
â”‚   â”œâ”€â”€ build-pkg.sh          # ğŸ“Œ æ‰“åŒ…è„šæœ¬ (DEB/RPM)
â”‚   â”œâ”€â”€ install_addon.sh      # æ’ä»¶å®‰è£…è„šæœ¬
â”‚   â””â”€â”€ verify-*.sh           # éªŒè¯è„šæœ¬
â”‚
â”œâ”€â”€ libs/                     # é¢„ç¼–è¯‘åŠ¨æ€åº“
â”‚   â”œâ”€â”€ libsherpa-onnx-c-api.so
â”‚   â””â”€â”€ libonnxruntime.so
â”‚
â”œâ”€â”€ packaging/                # æ‰“åŒ…èµ„æº
â”‚   â”œâ”€â”€ deb/                  # Debian åŒ…æ¨¡æ¿
â”‚   â””â”€â”€ rpm/                  # RPM åŒ…æ¨¡æ¿
â”‚
â”œâ”€â”€ _bmad/                    # BMAD å·¥ä½œæµé…ç½®
â”œâ”€â”€ _bmad-output/             # BMAD è¾“å‡ºæ–‡ä»¶
â”œâ”€â”€ Makefile                  # ğŸ“Œ é¡¹ç›®çº§æ„å»ºå…¥å£
â”œâ”€â”€ README.md                 # é¡¹ç›®è¯´æ˜
â””â”€â”€ CLAUDE.md                 # AI å¼€å‘æŒ‡å—
```

## å…³é”®ç›®å½•è¯´æ˜

### Part 1: voice_capsule/ (Flutter å®¢æˆ·ç«¯)

| ç›®å½• | è¯´æ˜ | å…³é”®æ–‡ä»¶ |
|------|------|----------|
| `lib/ffi/` | FFI ç»‘å®šå±‚ï¼Œè¿æ¥ Dart ä¸ C åº“ | `sherpa_ffi.dart`, `portaudio_ffi.dart` |
| `lib/services/` | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ | `audio_inference_pipeline.dart`, `fcitx_client.dart` |
| `lib/ui/` | UI ç»„ä»¶åº“ | `capsule_widget.dart`, `breathing_dot.dart` |
| `lib/constants/` | é…ç½®å¸¸é‡ | `capsule_colors.dart`, `window_constants.dart` |
| `linux/` | å¹³å°é…ç½® | `CMakeLists.txt` (RPATH é…ç½®) |

### Part 2: addons/fcitx5/ (C++ æ’ä»¶)

| ç›®å½• | è¯´æ˜ | å…³é”®æ–‡ä»¶ |
|------|------|----------|
| `src/` | æ’ä»¶æºç  | `nextalk.cpp` (å…¨éƒ¨å®ç°) |

## å…¥å£ç‚¹

| éƒ¨ä»¶ | å…¥å£æ–‡ä»¶ | è¯´æ˜ |
|------|----------|------|
| Flutter å®¢æˆ·ç«¯ | `lib/main.dart` | åˆå§‹åŒ–æ‰€æœ‰æœåŠ¡ï¼Œå¯åŠ¨ UI |
| Fcitx5 æ’ä»¶ | `src/nextalk.cpp` | `FCITX_ADDON_FACTORY` å®æ³¨å†Œ |

## æ•°æ®æµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Voice Capsule (Flutter)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  [éº¦å…‹é£] â”€â”€â–º PortAudio â”€â”€â–º AudioCapture â”€â”€â–º SherpaService     â”‚
â”‚                   â”‚              â”‚               â”‚              â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                         é›¶æ‹·è´ FFI (Pointer<Float>)             â”‚
â”‚                                                                 â”‚
â”‚  [è¯†åˆ«æ–‡æœ¬] â—„â”€â”€ AudioInferencePipeline â—„â”€â”€ SherpaService       â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  CapsuleWidget (UI æ˜¾ç¤º)                                        â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  FcitxClient â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Unix Domain Socket
                              â”‚ nextalk-fcitx5.sock
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Nextalk Addon (Fcitx5)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  [Socket ç›‘å¬] â”€â”€â–º handleClient() â”€â”€â–º commitText()             â”‚
â”‚                                            â”‚                    â”‚
â”‚                                            â–¼                    â”‚
â”‚  [å¿«æ·é”®] â”€â”€â–º handleKeyEvent() â”€â”€â–º sendCommandToFlutter()      â”‚
â”‚                                            â”‚                    â”‚
â”‚                                            â–¼                    â”‚
â”‚                               InputContext.commitString()       â”‚
â”‚                                            â”‚                    â”‚
â”‚                                            â–¼                    â”‚
â”‚                                     [ç›®æ ‡åº”ç”¨çª—å£]               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¾èµ–å…³ç³»

### Flutter å®¢æˆ·ç«¯ä¾èµ–

```yaml
# æ ¸å¿ƒä¾èµ–
flutter: sdk
ffi: ^2.1.0           # FFI åŸºç¡€
window_manager: ^0.5.1 # çª—å£ç®¡ç†
system_tray: ^2.0.3   # ç³»ç»Ÿæ‰˜ç›˜
shared_preferences: ^2.2.2  # é…ç½®æŒä¹…åŒ–

# ç½‘ç»œ/æ–‡ä»¶
dio: ^5.4.0           # HTTP ä¸‹è½½
archive: ^3.6.0       # tar.bz2 è§£å‹
crypto: ^3.0.3        # SHA256 æ ¡éªŒ

# å›½é™…åŒ–
flutter_localizations: sdk
intl: ^0.20.2

# é…ç½®
yaml: ^3.1.2
```

### C++ æ’ä»¶ä¾èµ–

- Fcitx5Core (>= 5.0.0)
- Fcitx5Utils
- POSIX Socket API
