# UI/UX 规范文档: Nextalk

简体中文 | [English](front-end-spec.md)

| 日期 | 版本 | 说明 | 作者 |
| :--- | :--- | :--- | :--- |
| 2025-12-29 | 2.0 | 基于实际代码实现的完整 UI/UX 规范 | Tech Writer (Paige) |
| 2025-12-21 | 1.0 | 初始 UI/UX 规范 (基于 Flutter 验证版) | UX Expert (Sally) |

## 1. 设计概述

**Nextalk** 的设计哲学是 **"Invisible but Powerful" (隐形但强大)**。
它不是一个需要用户长时间盯着的传统窗口，而是一个**召之即来、挥之即去**的桌面精灵。UI 必须极致轻量、对系统干扰最小，且在出现时提供令人愉悦的微交互动画。

### 核心体验目标

- **零干扰**: 默认隐藏，不占用任务栏，仅在托盘驻留。
- **即时反馈**: 语音 → 文字的转换必须有实时的视觉流动感。
- **状态清晰**: 用户能通过余光感知当前是"正在听"、"处理中"还是"已休眠"。
- **原生融合**: 窗口必须完美融入 Linux 桌面环境，无丑陋的系统边框。

## 2. 视觉规范

### 2.1 调色板

我们采用 **Dark Mode Only** 策略，确保在各种壁纸上都有良好的对比度和科技感。

| 颜色名称 | Hex / RGBA | 用途 |
| :--- | :--- | :--- |
| **Capsule Bg** | `rgba(25, 25, 25, 0.95)` | 胶囊主背景，深灰微透 |
| **Background Dark** | `#1A1A1A` | 对话框背景 (致命错误对话框) |
| **Accent Red** | `#FF4757` | **核心状态色** (录音中/呼吸灯) |
| **Text White** | `#FFFFFF` | 主文字颜色 |
| **Text Hint** | `#A4B0BE` | 提示文字 / 光标颜色 |
| **Text Processing** | `rgba(255, 255, 255, 0.8)` | 处理中状态文字 (变暗) |
| **Border Glow** | `rgba(255, 255, 255, 0.2)` | 内发光描边，提升玻璃质感 |
| **Shadow** | `rgba(0, 0, 0, 0.3)` | 外部柔和阴影，提供悬浮感 |
| **Warning** | `#FFA502` | 警告状态指示器 (黄色) |
| **Disabled** | `#636E72` | 无设备状态指示器 (灰色) |
| **Success** | `#2ECC71` | 剪贴板复制成功指示器 (绿色) |

### 2.2 排版

- **Font Family**: 系统默认无衬线字体。
- **主文字大小**: `18px`。
- **Weight**: `500` (Medium)。
- **Line Height**: `1.0` (紧凑，确保垂直居中)。

### 2.3 尺寸与布局

#### 主胶囊窗口

| 属性 | 数值 | 说明 |
| :--- | :--- | :--- |
| 窗口尺寸 | `400 × 120` px | 逻辑像素，包含阴影区域的安全画布 |
| 窗口尺寸 (扩展) | `400 × 180` px | 错误状态显示操作按钮时 |
| 胶囊高度 | `60` px | 固定 |
| 胶囊最小宽度 | `280` px | 最小内容宽度 |
| 胶囊最大宽度 | `380` px | 最大内容宽度 (自适应) |
| 圆角半径 | `40` px | 完全圆角 |
| 水平内边距 | `25` px | 左右内边距 |
| 指示器尺寸 | `30 × 30` px | 状态指示器直径 |
| 光标宽度 | `2` px | 闪烁光标宽度 |
| 光标高度 | `20` px | 闪烁光标高度 |

#### 初始化向导窗口

| 属性 | 数值 | 说明 |
| :--- | :--- | :--- |
| 窗口尺寸 | `540 × 540` px | 足以容纳手动安装引导内容 |
| 容器圆角 | `16` px | 卡片边框圆角 |
| 容器内边距 | `24` px | 内部边距 |

## 3. 核心界面设计

### 3.1 主胶囊窗口

这是用户 99% 时间看到的界面。

#### 状态 A: 聆听中 (Listening / Active)

- **左侧**: 红色实心圆点 (`#FF4757`, 30×30)。
  - *动画*: **呼吸** (Scale 1.0 ↔ 1.1, 正弦波) + **波纹扩散** (2 层波纹, Opacity 0.5 → 0, Scale 1.0 → 3.0)。
- **中间**: 实时识别出的文字流。
  - *样式*: 白色，单行，渐变文字流效果。
  - *动态*: 最新文字在右侧显示，字体大 (18px)；旧文字往左推，字体变小 (11px)、透明度降低 (0.35)。
  - *可见字符数*: 最多 25 个字符，左边缘淡出遮罩宽度 20px。
- **右侧**: 闪烁光标 (`#A4B0BE`, 2×20px)。
  - *动画*: 800ms 周期 Fade In/Out，EaseInOut 曲线。

#### 状态 B: 处理/提交中 (Processing)

- **左侧**: 红色圆点转为 **快速脉冲** (Scale 1.0 → 1.2 → 1.0, 400ms 周期)。
- **中间**: 文字颜色变暗 (`0.8` opacity)，表示正在上屏。
- **右侧**: 光标隐藏。

#### 状态 C: 错误 (Error)

- **左侧**: 变为 **黄色** (`#FFA502`, 警告) 或 **灰色** (`#636E72`, 无设备)。
- **中间**: 显示错误提示 (如 "麦克风不可用")。
- **右侧**: 无光标。
- **胶囊下方**: 错误操作按钮 (刷新/重试/关闭)。

错误类型及其指示器:

| 错误类型 | 指示器颜色 | 示例消息 |
| :--- | :--- | :--- |
| 无麦克风 | 灰色 `#636E72` | "未检测到麦克风" |
| 设备被占用 | 黄色 `#FFA502` | "麦克风正在被使用" |
| 权限不足 | 黄色 `#FFA502` | "麦克风权限被拒绝" |
| 设备丢失 | 黄色 `#FFA502` | "麦克风已断开" |
| 模型未找到 | 黄色 `#FFA502` | "未找到模型" |
| 模型损坏 | 黄色 `#FFA502` | "模型已损坏" |
| Socket 错误 | 黄色 `#FFA502` | "Fcitx5 未连接" |

#### 状态 D: 已复制到剪贴板 (Copied to Clipboard)

- **左侧**: 绿色圆形带勾选图标 (`#2ECC71`)。
- **中间**: 已识别的文本。
- **胶囊下方**: 绿色边框提示框，显示 "已复制到剪贴板，请粘贴"。

### 3.2 初始化向导

首次运行时未检测到 ASR 模型，或切换到没有可用模型的引擎时触发。

#### 阶段 1: 模式选择

- **布局**: 居中卡片容器。
- **标题**: "🎤 Nextalk 首次启动"。
- **说明**: "需要下载语音识别模型"。
- **按钮**:
  - **自动下载** (主按钮, 红色): "📥 自动下载 (推荐)"。
  - **手动安装** (边框按钮): "📁 手动安装"。

#### 阶段 2: 下载进度

- **标题**: "⬇️ 正在下载模型..."。
- **进度**: 大号百分比显示 (如 "45.2%")。
- **进度条**: 红色线性指示器，8px 高度，圆角。
- **大小信息**: "68MB / 150MB" 格式。
- **按钮**:
  - **切换手动安装**: 左对齐文字按钮。
  - **取消**: 右对齐文字按钮。

#### 阶段 3: 解压中

- **标题**: "📦 解压模型..."。
- **进度**: 与下载阶段相同。

#### 阶段 4: 手动安装引导

- **标题**: "📁 手动安装模型 (引擎名称)"。
- **步骤**:
  1. 下载模型文件 (带复制链接按钮)。
  2. 解压并放置到目标路径 (带打开目录按钮)。
  3. 期望的目录结构 (代码块显示)。
  - 对于 SenseVoice: 额外的步骤 1b 和 3b 用于 VAD 模型。
- **按钮**:
  - **检测模型** (主按钮): 检查模型是否正确放置。
  - **返回自动下载**: 文字按钮。

#### 阶段 5: 完成

- **图标**: 绿色勾选图标 (64px)。
- **标题**: "🎉 初始化完成！"。
- **提示**: "按下 Right Alt 键开始语音输入"。
- **按钮**: "开始使用"。

### 3.3 系统托盘

- **图标**: 简约麦克风图标，三种状态:
  - 正常: 默认图标。
  - 警告: 黄色调图标 (连接问题)。
  - 错误: 红色调图标 (严重错误)。
- **菜单项**:
  - **Nextalk** (禁用，仅作为标题)
  - ---
  - **显示 / 隐藏**
  - **重新连接 Fcitx5**
  - ---
  - **模型设置** → 子菜单:
    - **Zipformer** → 子菜单:
      - ● int8 模型 (更快)
      - 标准模型 (更准)
    - **SenseVoice**
  - ---
  - **语言** → 子菜单:
    - ● 简体中文
    - English
  - **设置** - 打开配置目录
  - ---
  - **退出**

注意: 当前选中项以 "● " 前缀标识 (system_tray Linux checkbox bug 的变通方案)。

### 3.4 致命错误对话框

用于不可恢复的应用程序错误。

- **尺寸**: 400px 宽度，高度自适应。
- **背景**: 深色 (`#1A1A1A`)。
- **圆角**: 16px。
- **内容**:
  - 带错误图标的标题 "应用程序错误"。
  - 等宽字体显示的错误消息，深色背景。
  - 可展开的 "详细信息" 区域显示堆栈跟踪。
  - 操作按钮: "复制诊断"、"退出"、"重启" (如可用)。

## 4. 交互流程

### 4.1 唤醒与输入 (Wake & Speak)

1. 用户按下配置的快捷键 (默认: `Right Alt`)。
2. 胶囊窗口 **瞬间出现** (无渐变，强调极速响应) 在上次记忆位置。
3. 左侧红灯开始呼吸，波纹开始扩散。
4. 用户说话 → 文字流实时上屏，呈现渐变流动效果。

### 4.2 自动完成 - Fcitx5 模式 (Auto Commit)

1. VAD 检测到静音 (可配置阈值)。
2. 红灯停止呼吸。
3. 文字通过 Unix Domain Socket 发送给 Fcitx5。
4. 窗口 **瞬间消失**。

### 4.3 自动完成 - 剪贴板模式 (Clipboard Mode)

当 Fcitx5 不可用时:

1. VAD 检测到静音。
2. 文字复制到系统剪贴板。
3. 状态切换为 **copiedToClipboard** (绿色勾选 + 提示)。
4. 1.5 秒后，窗口 **瞬间消失**。

### 4.4 手动完成 (Manual Commit)

1. 用户再次按下快捷键。
2. 立即停止录音。
3. 强制提交当前文字。
4. 窗口消失。

### 4.5 拖拽移动 (Drag to Move)

1. 用户按住胶囊窗口任意空白处。
2. 窗口跟随鼠标移动 (使用 `DragToMoveArea` 组件)。
3. 松开后，位置保存到 `SharedPreferences`，下次唤醒出现在此位置。

### 4.6 引擎切换 (Engine Switch)

1. 用户从托盘菜单选择不同引擎。
2. 如果模型不可用，显示初始化向导并指定目标引擎。
3. 模型就绪后，引擎切换并更新托盘菜单。
4. 系统通知确认切换成功/失败。

## 5. 动画参数规范

为了方便开发还原，这里列出具体的 Flutter 动画参数:

### 5.1 呼吸红点 (Breathing Dot)

| 属性 | 数值 |
| :--- | :--- |
| 公式 | `1.0 + 0.1 × sin(t)` |
| 周期 | `2000ms` |
| 缩放范围 | `1.0` ↔ `1.1` |
| 光晕效果 | Box shadow，半径 `8 × scale`，透明度 `0.6` |

使用全局 `AnimationTickerService` 进行预热。

### 5.2 波纹效果 (Ripple Effect)

| 属性 | 数值 |
| :--- | :--- |
| Duration | `1500ms` |
| Curve | `Curves.easeOutQuad` (爆发感) |
| Scale | `1.0` → `3.0` |
| Opacity | `0.5` → `0.0` |
| 波纹层数 | `2` (交错显示) |
| 重复 | 循环 |

### 5.3 光标闪烁 (Cursor Blink)

| 属性 | 数值 |
| :--- | :--- |
| Duration | `800ms` |
| Curve | `Curves.easeInOut` |
| Opacity | `1.0` ↔ `0.0` |
| 重复 | 来回 (Reverse) |

### 5.4 脉冲指示器 (Pulse Indicator - Processing)

| 属性 | 数值 |
| :--- | :--- |
| Duration | `400ms` |
| Scale 序列 | `1.0` → `1.2` → `1.0` |
| Curve | `Curves.easeInOut` |
| 重复 | 循环 |

### 5.5 渐变文字流 (Gradient Text Flow)

| 属性 | 数值 |
| :--- | :--- |
| 最大字体 | `18px` (最新文字) |
| 最小字体 | `11px` (最旧文字) |
| 最大透明度 | `1.0` |
| 最小透明度 | `0.35` |
| 可见字符数 | `25` |
| 淡出遮罩宽度 | `20px` |
| 文字对齐 | 右对齐 (最新文字固定在右侧) |

## 6. 状态机

### 6.1 胶囊状态 (CapsuleState)

```
┌─────────────────────────────────────────────────────────────┐
│                       CapsuleState                          │
├─────────────────────────────────────────────────────────────┤
│  idle              │ 窗口隐藏，无活动                        │
│  listening         │ 录音中，呼吸红点 + 波纹扩散              │
│  processing        │ VAD 触发，正在提交文字                   │
│  error             │ 发生错误，显示错误指示器                  │
│  initializing      │ 首次运行模型检查                        │
│  downloading       │ 模型下载中                              │
│  extracting        │ 模型解压中                              │
│  copiedToClipboard │ 已复制到剪贴板，显示绿色勾选             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 初始化阶段 (InitPhase)

```
┌─────────────────────────────────────────────────────────────┐
│                        InitPhase                            │
├─────────────────────────────────────────────────────────────┤
│  checkingModel  │ 检测模型状态                               │
│  selectingMode  │ 用户选择自动/手动安装                       │
│  downloading    │ 自动下载进行中                             │
│  extracting     │ 解压下载的归档文件                          │
│  verifying      │ 验证模型完整性                             │
│  manualGuide    │ 显示手动安装说明                           │
│  completed      │ 模型就绪，初始化完成                        │
│  error          │ 下载/解压失败                              │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 托盘状态 (TrayStatus)

```
┌─────────────────────────────────────────────────────────────┐
│                       TrayStatus                            │
├─────────────────────────────────────────────────────────────┤
│  normal   │ 默认图标，一切正常                               │
│  warning  │ 黄色图标，连接问题                               │
│  error    │ 红色图标，严重错误                               │
└─────────────────────────────────────────────────────────────┘
```

## 7. 异常处理

### 7.1 错误分类

| 类别 | 错误类型 | 指示器 | 操作 |
| :--- | :--- | :--- | :--- |
| **音频** | NoDevice, DeviceBusy, PermissionDenied, DeviceLost, InitFailed | 灰色/黄色圆点 | 刷新检测/重试 |
| **模型** | NotFound, Incomplete, Corrupted, LoadFailed | 黄色圆点 | 重新下载/删除并重新下载 |
| **Socket** | ConnectionFailed, Timeout, SendFailed, PermissionInsecure | 黄色圆点 | 重试提交/复制文本 |

### 7.2 错误操作按钮

- **主按钮**: 红色背景 (`#FF4757`)，白色文字。
- **次要按钮**: 仅文字，提示色 (`#A4B0BE`)。
- **最多按钮数**: 每个错误状态最多 3 个。
- **布局**: 水平行，居中。

### 7.3 文本保护机制

当提交失败时 (socket 错误、录音期间设备丢失):

- 原始文本保存在 `preservedText` 字段中。
- 用户可以: 复制文本 / 重试提交 / 放弃。
- 以斜体样式显示，带引号。

## 8. 国际化

### 8.1 支持的语言

- **简体中文**: `zh` (根据系统语言环境默认)
- **English**: `en`

### 8.2 语言切换

- 通过托盘菜单: 语言 → 简体中文 / English
- 即时生效，无需重启。
- 持久化到设置文件。

### 8.3 本地化元素

- 所有托盘菜单项
- 初始化向导文本和按钮
- 错误消息
- 提示文字 ("正在聆听..." / "Listening...")
- 操作按钮标签
- 通知消息

## 9. 快捷键配置

### 9.1 默认快捷键

- **按键**: `Right Alt` (单键，无修饰键)
- **行为**: 切换录音开/关

### 9.2 配置文件

位置: `~/.config/nextalk/settings.yaml`

```yaml
hotkey:
  key: altRight
  modifiers: []  # 或: [ctrl, shift]
```

### 9.3 支持的按键

- **修饰键** (作为主键): `altRight`, `altLeft`
- **功能键**: `f1`-`f12`
- **特殊键**: `space`, `escape`, `tab`, `enter`, `backspace`, `capsLock`
- **方向键**: `up`, `down`, `left`, `right`
- **编辑键**: `insert`, `delete`, `home`, `end`, `pageUp`, `pageDown`
- **字母键**: `a`-`z`
- **数字键**: `0`-`9`, `numpad0`-`numpad9`

### 9.4 支持的修饰键

- `ctrl`, `shift`, `alt`, `meta`

## 10. 窗口位置记忆

### 10.1 存储

- **键名**: `nextalk_window_x`, `nextalk_window_y`
- **存储**: `SharedPreferences`

### 10.2 有效范围校验

| 属性 | 数值 | 用途 |
| :--- | :--- | :--- |
| Min X | `-200` | 允许部分超出屏幕左侧 |
| Max X | `4000` | 支持多显示器配置 |
| Min Y | `-50` | 允许部分超出屏幕顶部 |
| Max Y | `2500` | 支持多显示器配置 |

### 10.3 保存触发

- 窗口移动 (拖拽释放)
- 窗口关闭
